generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Area {
  id        Int      @id @default(autoincrement())
  nome      String
  createdAt DateTime @default(now())

  demandas   Demanda[]
  membros    Membro[]
  pagamentos Pagamento[]
}

model Membro {
  id            Int      @id @default(autoincrement())
  nome          String
  fotoUrl       String?
  dre           String
  periodo       String
  isAtivo       Boolean  @default(true)
  isCoordenador Boolean  @default(false)
  areaId        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  area                  Area                    @relation(fields: [areaId], references: [id])
  avaliacoesFeitas      RespostaAvaliacao[]     @relation("AvaliacoesFeitas")
  avaliacoesRecebidas   RespostaAvaliacao[]     @relation("AvaliacoesRecebidas")
  planosAcao            PlanoAcao[]
  avaliacaoFeedbacks    AvaliacaoFeedback[]
  alocacoes             AlocacaoDemanda[]
  participacoes         ParticipacaoAvaliacao[]
  pagamentosResponsavel Pagamento[]
  respostasTermometro   RespostaTermometro[]
}

model Coordenador {
  id        Int      @id @default(autoincrement())
  nome      String
  usuario   String   @unique
  senhaHash String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  avaliacoesCriadas Avaliacao[]
}

model Avaliacao {
  id          Int       @id @default(autoincrement())
  nome        String
  dataInicio  DateTime
  dataFim     DateTime?
  finalizada  Boolean   @default(false)
  createdById Int
  createdAt   DateTime  @default(now())

  createdBy     Coordenador             @relation(fields: [createdById], references: [id])
  respostas     RespostaAvaliacao[]
  participantes ParticipacaoAvaliacao[]
}

model RespostaAvaliacao {
  id            Int      @id @default(autoincrement())
  avaliacaoId   Int
  avaliadorId   Int
  avaliadoId    Int
  notaEntrega   Int
  notaCultura   Int
  feedbackTexto String
  finalizada    Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  avaliacao         Avaliacao          @relation(fields: [avaliacaoId], references: [id])
  avaliador         Membro             @relation("AvaliacoesFeitas", fields: [avaliadorId], references: [id])
  avaliado          Membro             @relation("AvaliacoesRecebidas", fields: [avaliadoId], references: [id])
  planosAcao        PlanoAcao[]
  avaliacaoFeedback AvaliacaoFeedback?

  @@unique([avaliacaoId, avaliadorId, avaliadoId])
}

model PlanoAcao {
  id                  Int      @id @default(autoincrement())
  respostaAvaliacaoId Int
  responsavelId       Int
  descricao           String
  concluido           Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  respostaAvaliacao RespostaAvaliacao @relation(fields: [respostaAvaliacaoId], references: [id])
  responsavel       Membro            @relation(fields: [responsavelId], references: [id])
}

model AvaliacaoFeedback {
  id                  Int      @id @default(autoincrement())
  respostaAvaliacaoId Int      @unique
  avaliadoId          Int
  notaFeedback        Int
  createdAt           DateTime @default(now())

  respostaAvaliacao RespostaAvaliacao @relation(fields: [respostaAvaliacaoId], references: [id])
  avaliado          Membro            @relation(fields: [avaliadoId], references: [id])
}

model ParticipacaoAvaliacao {
  id                 Int     @id @default(autoincrement())
  avaliacaoId        Int
  membroId           Int
  respondeuAvaliacao Boolean @default(false)
  avaliouFeedbacks   Boolean @default(false)

  avaliacao Avaliacao @relation(fields: [avaliacaoId], references: [id])
  membro    Membro    @relation(fields: [membroId], references: [id])

  @@unique([avaliacaoId, membroId])
}

model Demanda {
  id            Int      @id @default(autoincrement())
  nome          String
  descricao     String?
  finalizada    Boolean  @default(false)
  creditoMembro Float    @default(0)
  creditoLider  Float    @default(0)
  idArea        Int?
  createdAt     DateTime @default(now())

  area       Area?             @relation(fields: [idArea], references: [id])
  alocacoes  AlocacaoDemanda[]
  pagamentos Pagamento[]
}

model AlocacaoDemanda {
  id        Int     @id @default(autoincrement())
  membroId  Int
  demandaId Int
  isLider   Boolean @default(false)

  membro  Membro  @relation(fields: [membroId], references: [id])
  demanda Demanda @relation(fields: [demandaId], references: [id])

  @@unique([membroId, demandaId])
}

enum StatusPagamento {
  ABERTO
  CONCLUIDO
}

model Pagamento {
  id            Int             @id @default(autoincrement())
  nome          String
  descricao     String?
  valor         Decimal         @db.Decimal(10, 2)
  notaFiscal    String?
  pdfUrl        String?
  status        StatusPagamento @default(ABERTO)
  demandaId     Int?
  areaId        Int?
  responsavelId Int?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  demanda     Demanda? @relation(fields: [demandaId], references: [id])
  area        Area?    @relation(fields: [areaId], references: [id])
  responsavel Membro?  @relation(fields: [responsavelId], references: [id])
}

// ==========================================
// PROCESSO SELETIVO - PROVAS
// ==========================================

enum StatusProva {
  RASCUNHO
  PUBLICADA
  ENCERRADA
}

enum TipoQuestao {
  MULTIPLA_ESCOLHA
  DISSERTATIVA
  VERDADEIRO_FALSO
}

enum StatusResultado {
  PENDENTE
  CORRIGIDA
}

model Prova {
  id          Int         @id @default(autoincrement())
  titulo      String
  descricao   String?
  tempoLimite Int?
  embaralhar  Boolean     @default(false)
  status      StatusProva @default(RASCUNHO)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  questoes   Questao[]
  resultados ResultadoProva[]
}

model Questao {
  id        Int         @id @default(autoincrement())
  provaId   Int
  tipo      TipoQuestao
  enunciado String
  pontos    Decimal     @db.Decimal(10, 2)
  ordem     Int

  prova        Prova             @relation(fields: [provaId], references: [id], onDelete: Cascade)
  alternativas Alternativa[]
  respostas    RespostaQuestao[]
  imagens      ImagemQuestao[]

  @@index([provaId])
}

model ImagemQuestao {
  id        Int      @id @default(autoincrement())
  questaoId Int
  url       String
  ordem     Int      @default(0)
  createdAt DateTime @default(now())

  questao Questao @relation(fields: [questaoId], references: [id], onDelete: Cascade)

  @@index([questaoId])
}

model Alternativa {
  id        Int     @id @default(autoincrement())
  questaoId Int
  texto     String
  correta   Boolean @default(false)
  ordem     Int

  questao Questao @relation(fields: [questaoId], references: [id], onDelete: Cascade)

  @@index([questaoId])
}

model Candidato {
  id        Int      @id @default(autoincrement())
  nome      String
  email     String   @unique
  dre       String   @default("") // TODO: Make unique in production if needed
  telefone  String?
  createdAt DateTime @default(now())

  resultados ResultadoProva[]
}

model ResultadoProva {
  id           Int             @id @default(autoincrement())
  provaId      Int
  candidatoId  Int
  status       StatusResultado @default(PENDENTE)
  notaFinal    Decimal?        @db.Decimal(10, 2)
  tempoGasto   Int?
  iniciadoEm   DateTime        @default(now())
  finalizadoEm DateTime?

  prova     Prova             @relation(fields: [provaId], references: [id])
  candidato Candidato         @relation(fields: [candidatoId], references: [id])
  respostas RespostaQuestao[]

  @@unique([provaId, candidatoId])
}

model RespostaQuestao {
  id            Int      @id @default(autoincrement())
  resultadoId   Int
  questaoId     Int
  alternativaId Int?
  respostaTexto String?
  pontuacao     Decimal? @db.Decimal(10, 2)
  corrigida     Boolean  @default(false)

  resultado ResultadoProva @relation(fields: [resultadoId], references: [id], onDelete: Cascade)
  questao   Questao        @relation(fields: [questaoId], references: [id])

  @@unique([resultadoId, questaoId])
}

// ==========================================
// TERMOMETRO
// ==========================================

model Termometro {
  id          Int      @id @default(autoincrement())
  nome        String
  dataInicial DateTime @db.Date()
  dataFinal   DateTime @db.Date()
  ativo       Boolean  @default(true)
  createdAt   DateTime @default(now())

  perguntas   PerguntaTermometro[]
  respostas   RespostaTermometro[]
}

model PerguntaTermometro {
  id        Int      @id @default(autoincrement())
  termometroId Int
  texto     String
  createdAt DateTime @default(now())

  termometro Termometro @relation(fields: [termometroId], references: [id])
}

model RespostaTermometro {
  id Int @id @default(autoincrement())
  idMembro Int
  idTermometro Int
  nota         Int

  membro Membro @relation(fields: [idMembro], references: [id])
  termometro Termometro @relation(fields: [idTermometro], references: [id])
}